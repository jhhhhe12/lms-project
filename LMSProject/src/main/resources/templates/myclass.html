<html layout:decorate="~{layout}">
	<div layout:fragment="content" class="main-content mt-5" >
		<script th:src="@{/js/apply_cancel_modal.js}"></script>
		<div class="col-xl-10 col-lg-11 mx-auto"> 
			<h1 class="mb-5 text-center">나의 학습방</h1>			    
			    
			    <!-- 신청한 강좌가 없을 때 메시지 -->
			    <div th:if="${!hasActiveApplications}" class="alert alert-info text-center">
			        <p class="mb-0">신청한 강좌가 없습니다. 새로운 강좌를 찾아보세요!</p>
			    </div>
			    
				<form method="get" action="/apply/list" class="mb-4">
				    <select name="filter" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
				        <option th:value="all"
				                th:selected="${filter == 'all'}">전체</option>

				        <option th:value="progress"
				                th:selected="${filter == 'progress'}">수강중</option>

				        <option th:value="complete"
				                th:selected="${filter == 'complete'}">수강완료</option>
				    </select>
				</form>
								
			    <!-- 수강 중인 강좌 리스트  -->
			    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" th:if="${hasActiveApplications}">					
			        <div class="col" th:each="apply, iterStat : ${applyList}" th:if="${apply.status == 1}">
			            <div class="card h-100 shadow-lg border-0 rounded-4 overflow-hidden transition duration-300 hover:shadow-xl">
			                
			                <!--  헤더 이미지 영역  -->
			                <div class="p-4 bg-info bg-opacity-10">
			                    <h5 class="card-title text-truncate fw-bold text-dark" th:text="${apply.course.title}">강좌 제목</h5>
			                    <p class="card-text small text-muted mb-0">
			                        <i class="bi bi-calendar me-1"></i> 신청일: <span th:text="${#temporals.format(apply.apldate, 'yyyy-MM-dd')}"></span>
			                    </p>
			                </div>

			                <!-- 카드 바디 -->
			                <div class="card-body d-flex flex-column justify-content-between">
			                    
			                    <!--  진도율 -->
								<div class="mb-3">
									<h6 class="text-secondary fw-semibold mb-2">현재 진도율</h6>

									<!-- progressRates 맵에서 현재 강좌의 진행률 출력 -->
									<div th:with="progressRate=${progressRates[apply.course.courseno] != null ? progressRates[apply.course.courseno] : 0}"
									     class="progress"
									     role="progressbar"
									     aria-label="진도율"
									     th:aria-valuenow="${progressRate}"
									     aria-valuemin="0"
									     aria-valuemax="100"
									     style="height: 28px;">
										<div class="progress-bar bg-primary progress-bar-striped progress-bar-animated"
										     th:style="|width: ${progressRate}%;|">
											<span class="fw-bold" th:text="${#numbers.formatDecimal(progressRate, 0, 1)} + '%'">0%</span>
										</div>
									</div>
								</div>
			                    
								
							<div class="mb-4">
								<div class="d-flex justify-content-between align-items-center">
										<!-- 상태 -->
									<div>
										<h6 class="text-secondary fw-semibold mb-2">상태</h6>
										<span th:with="progressRate=${progressRates[apply.course.courseno] != null ? progressRates[apply.course.courseno] : 0}"
									          th:text="${apply.status == 1 ? (progressRate == 100 ? '수강완료' : '수강중') : '취소'}"
									          th:class="${apply.status == 1 ? (progressRate == 100 ? 'badge text-bg-primary py-2 px-3 fs-6' : 'badge text-bg-success py-2 px-3 fs-6') : 'badge text-bg-secondary py-2 px-3 fs-6'}">
									    </span>
									</div>
		
										<!-- 퀴즈 점수 -->
									<div>
										<h6 class="text-secondary fw-semibold mb-2 text-end">퀴즈 점수</h6>
										<span th:text="${topScore[apply.course.courseno]} + '점'">
										</span>
									</div>
								</div>
							</div>	
							
							
			                    <!--  액션 버튼 -->
			                    <div class="d-flex gap-2 mt-auto">
			                        <a th:href="@{|/course/detail/${apply.course.courseno}|}" class="btn btn-info text-white w-50">
			                            <i class="bi bi-eye me-1"></i> 상세보기
			                        </a>
			                        <button type="button" 
			                                class="btn btn-outline-danger w-50" 
			                                th:data-bs-toggle="'modal'"  th:data-bs-target="'#cancelModal'"  th:data-applyno="${apply.applyno}"
			                                onclick="setCancelAction(this)">
			                            <i class="bi bi-x-circle me-1"></i> 취소
			                        </button>
			                    </div>
			                </div>
			            </div>
			        </div>
			    </div>												
			</div>
			<!--페이징-->
			<div th:if="${!paging.isEmpty()}" class="mt-5">
				<ul class="pagination justify-content-center">
					<!-- ⭐️ 변경: baseUrl을 /apply/list로 고정 -->
					<th:block th:with="baseUrl='/apply/list'">

			            <li class="page-item" th:classappend="${paging.first} ? 'd-none'">
			                <a class="page-link" th:href="@{|${baseUrl}?page=${paging.number-1}|}">
			                    <span>이전</span>
			                </a>
			            </li>
			            
			            <li th:each="page: ${#numbers.sequence(0, paging.totalPages-1)}" 
			            th:if="${page >= paging.number-5 and page <= paging.number+5}"
			            th:classappend="${page == paging.number} ? 'active'" class="page-item">
			                <a th:text="${page+1}" class="page-link" th:href="@{|${baseUrl}?page=${page}|}"></a>
			            </li>
			            
			            <li class="page-item" th:classappend="${paging.last} ? 'd-none'">
			                <a class="page-link" th:href="@{|${baseUrl}?page=${paging.number+1}|}">
			                    <span>다음</span>
			                </a>
			            </li>
			        </th:block>
				</ul>
			</div>
        <!-- 취소 확인 모달 -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger" id="cancelModalLabel">수강 취소 확인</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-center">정말로 이 강좌의 수강을 취소하시겠습니까?</p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" id="confirmCancelBtn" class="btn btn-danger">취소하기</button>
                    </div>
                </div>
            </div>
        </div>	            
	</div>
</html>