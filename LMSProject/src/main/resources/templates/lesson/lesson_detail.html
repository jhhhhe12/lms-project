<html layout:decorate="~{layout}">
<div layout:fragment="content" class="main-content mt-5">
  <div class="row g-4">

    <!-- 왼쪽: 강의 영상 영역 -->
    <div class="col-lg-9 col-md-8">
      <h3 class="mb-3 fw-bold" th:text="${lesson.title}">강의 제목</h3>

      <!-- 🎬 영상 -->
	  <div id="video-player" class="ratio ratio-16x9 mb-4 shadow-lg rounded" style="height: 70vh;"></div>

      <!-- 📄 강의 내용 -->
      <div class="p-4 border rounded bg-light">
        <h4 class="mb-3 text-primary"><i class="bi bi-file-text me-2"></i> 강의 내용</h4>
        <p th:text="${lesson.content}" style="white-space: pre-line;"></p>
      </div>

      <!-- 🔹 이전/다음 강의 이동 -->
      <div class="d-flex justify-content-between mt-4">
        <a th:id="prev-lesson-btn" 
           th:href="@{|/lesson/detail/${prevLessonNo}|}"
           th:classappend="${prevLessonNo != null ? 'btn-primary' : 'btn-outline-secondary disabled'}"
           class="btn">
           <i class="bi bi-arrow-left"></i> 이전 강의
        </a>

        <a th:id="next-lesson-btn" 
           th:href="@{|/lesson/detail/${nextLessonNo}|}"
           th:classappend="${nextLessonNo != null ? 'btn-primary' : 'btn-outline-secondary disabled'}"
           class="btn">
           다음 강의 <i class="bi bi-arrow-right"></i>
        </a>
      </div>

      <!-- 📊 진행도 표시 -->
      <div class="progress mt-4" style="height: 25px;">
        <div class="progress-bar bg-success fw-bold" role="progressbar"
             th:style="'width: ' + ${progress} + '%'" 
             th:text="${progress + '%'}">
        </div>
      </div>
    </div>

    <!-- 오른쪽: 탭 영역 -->
    <div class="col-lg-3 col-md-4">
      <h4 class="mb-3 text-secondary border-bottom pb-2">전체 강의</h4>

      <!-- ✅ 탭 버튼 -->
      <ul class="nav nav-tabs" id="courseTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="course-tab" data-bs-toggle="tab" data-bs-target="#course-pane"
                  type="button" role="tab">강의목록</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="memo-tab" data-bs-toggle="tab" data-bs-target="#memo-pane"
                  type="button" role="tab">메모하기</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="quiz-tab" data-bs-toggle="tab" data-bs-target="#quiz-pane"
                  type="button" role="tab">퀴즈풀기</button>
        </li>
      </ul>

      <!-- ✅ 탭 내용 -->
      <div class="tab-content mt-3" id="courseTabsContent">

        <!-- 🔹 강의목록 탭 -->
        <div class="tab-pane fade show active" id="course-pane" role="tabpanel" aria-labelledby="course-tab">
          <div class="list-group shadow-sm" style="max-height: 60vh; overflow-y: auto;">
            <a th:each="listItem : ${course.lessonList}" 
               th:href="@{|/lesson/detail/${listItem.lessonno}|}"
               th:data-lessonno="${listItem.lessonno}"
               th:classappend="${listItem.lessonno == lesson.lessonno ? 'active' : ''}"
               class="list-group-item list-group-item-action py-3">

              <div class="d-flex w-100 justify-content-between align-items-center">
                <small class="fw-bold" th:text="${listItem.title}"></small>
                <span class="text-success fw-bold ms-2 complete-check"
                      th:if="${completedLessons.contains(listItem.lessonno)}">✔</span>
              </div>
              <small th:text="${listItem.time} + '분'"></small>
            </a>
          </div>
        </div>

        <!-- 🔹 메모하기 탭 -->
        <div class="tab-pane fade" id="memo-pane" role="tabpanel" aria-labelledby="memo-tab">
          <div class="card p-3 shadow-sm">
            <form id="memoForm" th:action="@{|/memo/create/${lesson.lessonno}|}" method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrfToken"/>
              <input type="hidden" name="lessonno" th:value="${lesson.lessonno}" />
              <textarea name="content" class="form-control mb-3" rows="15" placeholder="메모를 입력하세요"></textarea>
              <button type="submit" class="btn btn-primary w-100">저장</button>
            </form>
          </div>
        </div>

        <!-- 🔹 퀴즈풀기 탭 -->
        <div class="tab-pane fade" id="quiz-pane" role="tabpanel" aria-labelledby="quiz-tab">
          <div class="p-3 text-center">

            <!-- 퀴즈 버튼 -->
            <form th:if="${quiz != null}" 
                  th:action="@{|/quiz/test/${quiz.quizno}|}" 
                  method="get" 
                  class="text-center"
                  sec:authorize="isAuthenticated()">
              <button type="submit" class="btn btn-warning btn-lg w-100 mb-3">퀴즈풀기</button>
            </form>

            <!-- 퀴즈 없음 -->
            <p th:if="${quiz == null}" class="text-muted mt-3">
              이 강의에는 퀴즈가 없습니다.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ 스크립트 -->
<th:block layout:fragment="script">
  <script th:inline="javascript">
    var videoId = /*[[${lesson.video}]]*/ '';
	if (videoId.includes("v=")) {
	  videoId = videoId.split("v=")[1].split("&")[0];
	} else if (videoId.includes("youtu.be/")) {
	  videoId = videoId.split("youtu.be/")[1].split("?")[0];
	}
    var lessonNo = /*[[${lesson.lessonno}]]*/ null;
    var csrfToken = /*[[${_csrf.token}]]*/ '';
    var completedLessons = /*[[${completedLessons}]]*/ [];
    var progressBar = document.querySelector(".progress-bar");

    if (videoId.includes("v=")) {
      videoId = videoId.split("v=")[1].split("&")[0];
    }

    if (typeof completedLessons === 'string') {
      try { completedLessons = JSON.parse(completedLessons); } catch(e) { completedLessons = []; }
    }

    function markCompletedLessons() {
      completedLessons.forEach(id => {
        const item = document.querySelector(`[data-lessonno="${id}"]`);
        if (item && !item.querySelector(".complete-check")) {
          const check = document.createElement("span");
          check.classList.add("complete-check", "text-success", "fw-bold", "ms-2");
          check.innerHTML = "✔";
          item.querySelector("div").appendChild(check);
        }
      });
    }
    markCompletedLessons();

    // YouTube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('video-player', {
        videoId: videoId,
        events: { 'onStateChange': onPlayerStateChange }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        alert("축하합니다! 강의를 시청 완료했습니다.");

        fetch(`/lesson/complete/${lessonNo}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": csrfToken
          }
        })
        .then(res => res.json())
        .then(data => {
          alert(`${data.message} (진행률: ${data.progress.toFixed(1)}%)`);
          completedLessons = data.completedLessons;
          markCompletedLessons();
          if (progressBar) {
            progressBar.style.width = data.progress + "%";
            progressBar.innerText = data.progress.toFixed(1) + "%";
          }
        })
        .catch(err => console.error(err));
      }
    }
	// 메모글을 저장하면 영상이 초기화되는 문제를 해결하기 위해 JS에서 submit 이벤트를 가로채 Ajax로 전달하기
	document.addEventListener("DOMContentLoaded", function() {
	    const memoForm = document.getElementById("memoForm");
	    const csrf = document.getElementById("csrfToken").value;
	    const memoContent = document.querySelector("textarea[name='content']");
	    const lessonNo = /*[[${lesson.lessonno}]]*/ null;

	    memoForm.addEventListener("submit", function(e) {
	        e.preventDefault();  // 🔥 새로고침 방지

	        fetch(`/memo/create-ajax/${lessonNo}`, {
	            method: "POST",
	            headers: {
	                "Content-Type": "application/json",
	                "X-CSRF-TOKEN": csrf
	            },
	            body: JSON.stringify({ content: memoContent.value })
	        })
	        .then(res => res.json())
	        .then(data => {
	            alert("메모가 저장되었습니다!");
	        })
	        .catch(err => console.error(err));
	    });
	});

  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</th:block>
</html>
