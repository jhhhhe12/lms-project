<html layout:decorate="~{layout}">
	<div layout:fragment="content" class="main-content mt-5">
        <div class="col-md-9 col-lg-7 mx-auto"> 
			<h1 class="mb-5 text-center" sec:authorize="hasAnyRole('USER','INSTRUCTOR')">마이 페이지</h1>
			<h1 class="mb-5 text-center" sec:authorize="hasRole('ADMIN')">회원 정보 관리</h1>
			<div class="card shadow-sm mb-4">
			    <div class="card-body">
			        <div class="row align-items-center">
			            <div class="col-sm-4 col-md-3 text-center mb-3 mb-sm-0">
			                <img th:src="${member.proimg}" class="img-fluid rounded-circle shadow-sm" alt="프로필 이미지" style="width: 120px; height: 120px; object-fit: cover;">
			            </div>
			            <!--강사는 출석체크 기능 x-->
			            <div class="col-sm-8 col-md-9" >
			                <h4 class="card-title" th:text="${member.memberid}">사용자 아이디</h4>
			                <p class="card-text text-muted mb-1" th:text="${member.email}"></p>
			                <p class="card-text text-muted" th:text="${member.role}"></p>			               
			            </div>
			        </div>
			    </div>
			</div>
			<!--회원정보-->
            <h5 class="mb-3 text-secondary">개인 정보</h5>
            <ul class="list-group list-group-flush border rounded shadow-sm mb-4">
                
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-bold">이름</span>
                    <span th:text="${member.name}"></span>
				</li>

                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-bold">전화번호</span>
                    <span th:text="${member.cellnum}"></span>
				</li>
				
				<li class="list-group-item d-flex justify-content-between align-items-center">
				    <span class="fw-bold">생년월일</span>
				    <span th:text="${member.birth}"></span>
				</li>
				
				<li class="list-group-item d-flex justify-content-between align-items-center">
				    <span class="fw-bold">이메일</span>
				    <span th:text="${member.email}"></span>
				</li>
				
				<!-- 포인트 테스트 -->
				<li class="list-group-item d-flex justify-content-between align-items-center" sec:authorize="hasAnyRole('USER', 'ADMIN')">
				    <span class="fw-bold">포인트</span>
				    <span th:text="${member.point}"></span>
				</li>
				<!--출석일-->
				<li class="list-group-item d-flex justify-content-between align-items-center" sec:authorize="hasAnyRole('USER', 'ADMIN')">
                    <span class="fw-bold">총 출석일</span>
                    <span th:text="${attendanceCount} + '일'"></span>
				</li>
				<!--학교-->
				<li class="list-group-item d-flex justify-content-between align-items-center" sec:authorize="hasAnyRole('INSTRUCTOR')">
				    <span class="fw-bold">학교</span>
				    <span th:text="${member.schoolName}"></span>
				</li>
			</ul>
            
            <h5 class="mb-3 text-secondary">계정 정보</h5>
			<ul class="list-group list-group-flush border rounded shadow-sm">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    <span class="text-muted small">가입일</span>
                    <span class="small" th:text="${#temporals.format(member.creDate, 'yyyy년 MM월 dd일 HH:mm')}"></span>
				</li>

                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    <span class="text-muted small">최근 정보 수정일</span>
                    <span class="small" th:text="${#temporals.format(member.modDate, 'yyyy년 MM월 dd일 HH:mm')}"></span>
				</li>
			</ul>
			<!--강사등록-->
			<script src="/js/instructor_regist.js"></script>
			<!--강좌를 등록한 강사가 회원탈퇴시-->
			<script src="/js/instructor_delete_err_msg.js"></script>
			
            <div class="d-flex justify-content-end mt-5">
				
				<a class="btn btn-secondary me-2"
				   sec:authorize="hasRole('ADMIN')"
				   th:href="@{/member/list}">
				    리스트로 가기
				</a>

				<a class="btn btn-secondary me-2"
				   sec:authorize="!hasRole('ADMIN')"
				   th:href="@{/}">
				    홈으로 가기
				</a>
				<!--팝업창 띄우는 버튼 추가-->
				<button class="btn btn-primary me-2" sec:authorize="hasRole('ADMIN')"
				th:onclick="'openRolePopup(' + ${member.memberno} + ')'"
				th:if="${member.role.name() == 'USER'}">강사 등록</button> 
                <a th:href="@{|/member/modify/${member.memberno}|}" class="btn btn-primary me-2">정보 수정</a>
                <a th:href="@{|/member/delete/${member.memberno}|}" class="btn btn-danger" 
                   onclick="return confirm('정말로 탈퇴하시겠습니까?');">회원 탈퇴</a>
				<div id="message-box" th:data-error-message="${errorMessage}" hidden></div>
            </div>
		</div>
		<script>
		  // URL에 refresh=true가 있으면 자동 새로고침 후 파라미터 제거
		  if (window.location.search.includes('refresh=true')) {
		    // 새로고침 후 URL 깔끔하게 정리
		    window.history.replaceState({}, document.title, window.location.pathname);
			// 새로고침을 너무 빠르게 실행하면 브라우저가 URL 정리 전 reload할 수 있으므로,
		    // 아주 짧게(100ms) 지연시켜 안전하게 처리
		    setTimeout(() => {
		      location.reload();
		    }, 100);
		  }
		</script>		
	</div>
</html>