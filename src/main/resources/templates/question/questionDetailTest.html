<html layout:decorate="~{layout}">
<div layout:fragment="content" class="main-content mt-5">
	<h1>질문 상세페이지</h1>
	<hr>
	<h2 class="border-bottom py-2" th:text="${question.title}"></h2>
	<div class="card my-3">
		<div class="card-body">
			<div class="card-text" style="white-space: pre-line;" th:text="${question.content}"></div>
			<div class="d-flex justify-content-end">
				<div class="badge bg-light text-dark p-2 text-start">
					<div class="mb-2">
						<span th:if="${question.member != null}" th:text="${question.member.name}"></span>
					</div>
					<div th:text="${#temporals.format(question.credate, 'yyyy-MM-dd HH:mm')}"></div>
				</div>
			</div>
			<div sec:authorize="isAuthenticated()" class="my-3">
				<a th:if="${#authentication.name == question.member.memberid or #authorization.expression('hasRole(''ADMIN'')')}"
					th:href="@{|/question/modify/${question.questionno}|}"
					class="btn btn-sm btn-outline-secondary">수정</a>
				<form th:if="${#authentication.name == question.member.memberid or #authorization.expression('hasRole(''ADMIN'')')}"
					th:action="@{|/question/delete/${question.questionno}|}" method="post" style="display:inline;"
					class="delete-form">
					<button type="submit" class="btn btn-sm btn-outline-secondary">삭제</button>
				</form>
			</div>
		</div>
	</div>

	<h5 class="border-bottom my-3 py-2" th:text="|${#lists.size(question.answerList)}개의 답변이 있습니다.|"></h5>

	<div class="card my-3" th:each="answer : ${question.answerList}" th:attr="data-answerno=${answer.answerno}">
		<div class="card-body">
			<div class="answer-content" style="white-space: pre-line;" th:text="${answer.content}"></div>

			<!-- 수정 폼 (초기엔 hidden) -->
			<form class="answer-edit-form" th:action="@{|/answer/modify/${answer.answerno}|}" method="post"
				style="display:none;">
				<textarea name="content" class="form-control my-2" rows="3" th:text="${answer.content}"></textarea>
				<button type="submit" class="btn btn-sm btn-primary">저장</button>
				<button type="button" class="btn btn-sm btn-secondary cancel-edit">취소</button>
			</form>

			<div class="d-flex justify-content-end mt-2">
				<div class="badge bg-light text-dark p-2 text-start">
					<div class="mb-2">
						<span th:if="${answer.member != null}" th:text="${answer.member.name}"></span>
					</div>
					<div th:text="${#temporals.format(answer.credate, 'yyyy-MM-dd HH:mm')}"></div>
				</div>

				<!-- 작성자가 본인이고, 역할이 INSTRUCTOR 또는 ADMIN인 경우 -->
				<div th:if="${#authentication.name == answer.member.memberid}" class="ms-2">
					<button type="button" class="btn btn-sm btn-outline-secondary edit-btn">
						수정
					</button>
					<form th:action="@{|/answer/delete/${answer.answerno}|}" method="post" style="display:inline;">
						<button type="submit" class="btn btn-sm btn-outline-secondary">
							삭제
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	<form th:if="${course != null}" th:action="@{|/course/detail/${course.courseno}|}" method="get">
		<button type="submit" class="btn btn-primary my-2">돌아가기</button>
	</form>

	<form th:action="@{|/answer/create/${question.questionno}|}" th:object="${answerForm}" method="post" class="my-3">
		<div th:replace="~{form_errors :: formErrorsFragment}"></div>

		<!-- 로그인한 사용자만 textarea 표시 -->
		<textarea sec:authorize="hasRole('INSTRUCTOR') or hasRole('ADMIN')" th:field="*{content}" rows="5"
			class="form-control"></textarea>

		<!-- 답변 등록 버튼도 강사만 -->
		<input sec:authorize="hasRole('INSTRUCTOR') or hasRole('ADMIN')" type="submit" value="답변 등록"
			class="btn btn-primary my-2">

	</form>

</div>

<script layout:fragment="script" type="text/javascript">
	// 삭제 confirm
	const deleteForms = document.getElementsByClassName('delete-form');
	Array.from(deleteForms).forEach(function (form) {
		form.addEventListener('submit', function (e) {
			if (!confirm("정말로 삭제하시겠습니까?")) {
				e.preventDefault(); // 취소하면 제출 막기
			}
		});
	});

	// 답변 수정 버튼
	const editButtons = document.getElementsByClassName("edit-btn");
	Array.from(editButtons).forEach(function (btn) {
		btn.addEventListener('click', function () {
			const cardBody = btn.closest('.card-body');
			cardBody.querySelector('.answer-content').style.display = 'none';
			cardBody.querySelector('.answer-edit-form').style.display = 'block';
		});
	});

	// 답변 수정 취소 버튼
	const cancelButtons = document.getElementsByClassName("cancel-edit");
	Array.from(cancelButtons).forEach(function (btn) {
		btn.addEventListener('click', function () {
			const cardBody = btn.closest('.card-body');
			cardBody.querySelector('.answer-edit-form').style.display = 'none';
			cardBody.querySelector('.answer-content').style.display = 'block';
		});
	});
</script>

</html>